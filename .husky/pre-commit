#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}üîç Running pre-commit checks...${NC}"

# Get list of staged files
staged_files=$(git diff --cached --name-only)

# Check if there are any staged files
if [ -z "$staged_files" ]; then
    echo "${YELLOW}No staged files to check${NC}"
    exit 0
fi

# Initialize error flag
has_errors=false

# Check Python files
python_files=$(echo "$staged_files" | grep -E '\.(py)$' | head -20)
if [ ! -z "$python_files" ]; then
    echo "${YELLOW}üìù Checking Python files...${NC}"
    
    # Activate virtual environment if it exists
    if [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
    fi
    
    # Check if Python files exist and run checks
    for file in $python_files; do
        if [ -f "$file" ]; then
            # Black formatting check
            if ! ./venv/bin/black --check "$file" 2>/dev/null; then
                echo "${RED}‚ùå Black formatting issues in: $file${NC}"
                echo "${YELLOW}üí° Run: ./venv/bin/black $file${NC}"
                has_errors=true
            fi
            
            # Ruff linting
            if ! ./venv/bin/ruff check "$file" 2>/dev/null; then
                echo "${RED}‚ùå Ruff linting issues in: $file${NC}"
                echo "${YELLOW}üí° Run: ./venv/bin/ruff check --fix $file${NC}"
                has_errors=true
            fi
        fi
    done
fi

# Check TypeScript/JavaScript files  
ts_files=$(echo "$staged_files" | grep -E '\.(ts|tsx|js|jsx)$' | head -20)
if [ ! -z "$ts_files" ]; then
    echo "${YELLOW}üìù Checking TypeScript/JavaScript files...${NC}"
    
    # Check if we have pnpm and node_modules
    if command -v pnpm >/dev/null 2>&1 && [ -d "node_modules" ]; then
        # ESLint check
        if ! pnpm exec eslint $ts_files --quiet 2>/dev/null; then
            echo "${RED}‚ùå ESLint issues found${NC}"
            echo "${YELLOW}üí° Run: pnpm run lint --fix${NC}"
            has_errors=true
        fi
        
        # Prettier check
        if ! pnpm exec prettier --check $ts_files 2>/dev/null; then
            echo "${RED}‚ùå Prettier formatting issues found${NC}"
            echo "${YELLOW}üí° Run: pnpm run format${NC}"
            has_errors=true
        fi
        
        # TypeScript type check for changed files
        if echo "$ts_files" | grep -E '\.(ts|tsx)$' >/dev/null; then
            if ! pnpm exec tsc --noEmit 2>/dev/null; then
                echo "${RED}‚ùå TypeScript type errors found${NC}"
                echo "${YELLOW}üí° Run: pnpm run type-check${NC}"
                has_errors=true
            fi
        fi
    else
        echo "${YELLOW}‚ö†Ô∏è  pnpm or node_modules not available, skipping JS/TS checks${NC}"
    fi
fi

# Check for common issues
echo "${YELLOW}üîç Checking for common issues...${NC}"

# Check for merge conflict markers
if echo "$staged_files" | xargs grep -l "^<<<<<<< \|^======= \|^>>>>>>> " 2>/dev/null; then
    echo "${RED}‚ùå Merge conflict markers found in staged files${NC}"
    has_errors=true
fi

# Check for TODO/FIXME comments (warning only)
todo_files=$(echo "$staged_files" | xargs grep -l "TODO\|FIXME" 2>/dev/null || true)
if [ ! -z "$todo_files" ]; then
    echo "${YELLOW}‚ö†Ô∏è  TODO/FIXME comments found in:${NC}"
    echo "$todo_files" | sed 's/^/  - /'
fi

# Check for console.log in TypeScript files (warning only for non-test files)
console_files=$(echo "$staged_files" | grep -E '\.(ts|tsx|js|jsx)$' | grep -v -E '\.(test|spec)\.' | xargs grep -l "console\." 2>/dev/null || true)
if [ ! -z "$console_files" ]; then
    echo "${YELLOW}‚ö†Ô∏è  console.* statements found in:${NC}"
    echo "$console_files" | sed 's/^/  - /'
fi

# Check for secrets or sensitive information
# More specific pattern to avoid false positives:
# - Look for actual assignment patterns with = or :
# - Exclude common false positives like apiKey props, process.env references
# - Focus on literal string assignments that look like real secrets
# - Exclude seed scripts, test files, examples, and init scripts
sensitive_patterns='(password|secret|token|api_key|apikey|private_key|access_key)[[:space:]]*[:=][[:space:]]*["'"'"'][0-9a-zA-Z]{20,}["'"'"']'
sensitive_files=$(echo "$staged_files" | grep -v -E 'seed|test|spec|\.md$|\.example|init-|create-' | xargs grep -l -E "$sensitive_patterns" 2>/dev/null || true)

# Also check for AWS credentials and private keys (but exclude seed/test files)
aws_pattern='(AKIA[0-9A-Z]{16}|aws_secret_access_key|aws_access_key_id)[[:space:]]*[:=][[:space:]]*["'"'"']'
aws_files=$(echo "$staged_files" | grep -v -E 'seed|test|spec|\.md$|\.example|init-|create-' | xargs grep -l -E "$aws_pattern" 2>/dev/null || true)

# Check for private key patterns (but exclude seed/test files)
private_key_pattern='-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----'
key_files=$(echo "$staged_files" | grep -v -E 'seed|test|spec|\.md$|\.example|init-|create-' | xargs grep -l -F "$private_key_pattern" 2>/dev/null || true)

all_sensitive_files=$(printf "%s\n%s\n%s" "$sensitive_files" "$aws_files" "$key_files" | sort -u | grep -v '^$' || true)

if [ ! -z "$all_sensitive_files" ]; then
    echo "${RED}‚ùå Potential secrets found in:${NC}"
    echo "$all_sensitive_files" | sed 's/^/  - /'
    echo "${YELLOW}üí° Please review and remove any hardcoded secrets${NC}"
    has_errors=true
fi

# Run tests for affected areas (optional, can be disabled for speed)
if [ "$SKIP_TESTS" != "true" ]; then
    echo "${YELLOW}üß™ Running quick tests for changed files...${NC}"
    
    # Run tests for Python files
    if [ ! -z "$python_files" ] && [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
        # Run only fast unit tests, not integration tests, exclude packages/schemas
        if ! python -m pytest --tb=short --maxfail=3 -q -x --ignore=packages/schemas/tests 2>/dev/null; then
            echo "${YELLOW}‚ö†Ô∏è  Some tests failed, but allowing commit (run full test suite before push)${NC}"
        fi
    fi
    
    # Run TypeScript tests
    if [ ! -z "$ts_files" ] && command -v pnpm >/dev/null 2>&1; then
        # Run only unit tests related to changed files
        if ! timeout 30 pnpm run test:unit --run --passWithNoTests 2>/dev/null; then
            echo "${YELLOW}‚ö†Ô∏è  Some frontend tests failed, but allowing commit (run full test suite before push)${NC}"
        fi
    fi
fi

# Final result
if [ "$has_errors" = true ]; then
    echo "${RED}‚ùå Pre-commit checks failed! Please fix the issues above.${NC}"
    echo "${YELLOW}üí° You can skip these checks with: git commit --no-verify${NC}"
    exit 1
else
    echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
    exit 0
fi