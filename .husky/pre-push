#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}ğŸš€ Running pre-push checks...${NC}"

# Get current branch
current_branch=$(git branch --show-current)

# Protected branches that require extra checks
protected_branches="main develop"

if echo "$protected_branches" | grep -w "$current_branch" > /dev/null; then
    echo "${YELLOW}ğŸ›¡ï¸  Pushing to protected branch: $current_branch${NC}"
    
    # Run comprehensive tests
    echo "${YELLOW}ğŸ§ª Running comprehensive test suite...${NC}"
    
    # Check if virtual environment exists and run Python tests
    if [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
        echo "${YELLOW}  Running Python tests...${NC}"
        # Skip all tests as per user request
        echo "${YELLOW}  Tests excluded from pre-push checks${NC}"
    fi
    
    # Check if pnpm is available and run Node.js tests
    if command -v pnpm >/dev/null 2>&1 && [ -d "node_modules" ]; then
        echo "${YELLOW}  Running TypeScript tests...${NC}"
        # Skip all tests as per user request
        echo "${YELLOW}  Tests excluded from pre-push checks${NC}"
        
        # Run type checking
        echo "${YELLOW}  Running type checks...${NC}"
        if ! pnpm run type-check; then
            echo "${RED}âŒ Type checking failed!${NC}"
            exit 1
        fi
        
        # Run linting
        echo "${YELLOW}  Running linting...${NC}"
        if ! pnpm run lint; then
            echo "${RED}âŒ Linting failed!${NC}"
            exit 1
        fi
    fi
    
    # Check for proper commit message format on main/develop
    last_commit_msg=$(git log -1 --pretty=%B)
    if ! echo "$last_commit_msg" | grep -E "^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?: .+" > /dev/null; then
        echo "${RED}âŒ Invalid commit message format!${NC}"
        echo "${YELLOW}ğŸ’¡ Use conventional commits: type(scope): description${NC}"
        echo "${YELLOW}   Examples: feat(auth): add user login, fix(api): resolve 404 error${NC}"
        exit 1
    fi
    
else
    echo "${YELLOW}ğŸ“ Pushing to feature branch: $current_branch${NC}"
    
    # Run lighter checks for feature branches
    echo "${YELLOW}ğŸ” Running quick checks...${NC}"
    
    # Quick linting check
    if command -v pnpm >/dev/null 2>&1 && [ -d "node_modules" ]; then
        if ! pnpm run lint --quiet; then
            echo "${RED}âŒ Linting issues found!${NC}"
            echo "${YELLOW}ğŸ’¡ Run: pnpm run lint --fix${NC}"
            exit 1
        fi
    fi
    
    # Quick Python check
    if [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
        if ! ./venv/bin/ruff check .; then
            echo "${RED}âŒ Python linting issues found!${NC}"
            echo "${YELLOW}ğŸ’¡ Run: ./venv/bin/ruff check --fix .${NC}"
            exit 1
        fi
    fi
fi

# Check for large files (>10MB)
echo "${YELLOW}ğŸ“ Checking for large files...${NC}"
large_files=$(git diff --cached --name-only | xargs ls -la 2>/dev/null | awk '$5 > 10485760 {print $9 " (" $5 " bytes)"}')
if [ ! -z "$large_files" ]; then
    echo "${RED}âŒ Large files detected:${NC}"
    echo "$large_files"
    echo "${YELLOW}ğŸ’¡ Consider using Git LFS for large files${NC}"
    exit 1
fi

# Check for private/sensitive files
echo "${YELLOW}ğŸ”’ Checking for sensitive files...${NC}"
sensitive_files=$(git diff --cached --name-only | grep -E "\.(pem|key|p12|pfx|env\.local|\.env\..+)$" || true)
if [ ! -z "$sensitive_files" ]; then
    echo "${RED}âŒ Sensitive files detected:${NC}"
    echo "$sensitive_files"
    echo "${YELLOW}ğŸ’¡ Add these files to .gitignore${NC}"
    exit 1
fi

echo "${GREEN}âœ… Pre-push checks completed successfully!${NC}"
exit 0