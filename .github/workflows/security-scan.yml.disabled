name: Security Scanning and Compliance

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - terraform
          - containers
          - dependencies
          - sast
          - compliance

permissions:
  contents: read
  security-events: write
  actions: read

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  terraform-security-scan:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || inputs.scan_type == 'all' || inputs.scan_type == 'terraform'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy Terraform scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'infra/terraform'
          format: 'sarif'
          output: 'trivy-terraform-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Run Trivy with JSON output for detailed analysis
        id: trivy-terraform
        run: |
          docker run --rm -v "$PWD:/workspace" aquasec/trivy config /workspace/infra/terraform \
            --format json --output /workspace/trivy-terraform-results.json \
            --severity CRITICAL,HIGH,MEDIUM || echo "trivy_failed=true" >> $GITHUB_OUTPUT

          if [ -f trivy-terraform-results.json ]; then
            # Count vulnerabilities by severity
            CRITICAL=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "CRITICAL")] | length' trivy-terraform-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "HIGH")] | length' trivy-terraform-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "MEDIUM")] | length' trivy-terraform-results.json 2>/dev/null || echo "0")

            echo "trivy_critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "trivy_high=$HIGH" >> $GITHUB_OUTPUT
            echo "trivy_medium=$MEDIUM" >> $GITHUB_OUTPUT

            # Generate human-readable report
            echo "## Terraform Security Scan Results" > terraform-security-report.md
            echo "" >> terraform-security-report.md
            echo "| Severity | Count |" >> terraform-security-report.md
            echo "|----------|-------|" >> terraform-security-report.md
            echo "| Critical | $CRITICAL |" >> terraform-security-report.md
            echo "| High | $HIGH |" >> terraform-security-report.md
            echo "| Medium | $MEDIUM |" >> terraform-security-report.md
            echo "" >> terraform-security-report.md

            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "‚ùå **Critical or High severity issues found!**" >> terraform-security-report.md
              echo "" >> terraform-security-report.md
              echo "### Critical and High Severity Issues:" >> terraform-security-report.md
              jq -r '.Results[]?.Misconfigurations[]? | select(.Severity == "CRITICAL" or .Severity == "HIGH") | "- **\(.Title)** (\(.Severity)): \(.Description)"' trivy-terraform-results.json >> terraform-security-report.md
            else
              echo "‚úÖ **No critical or high severity issues found.**" >> terraform-security-report.md
            fi
          fi

      - name: Run Checkov security scan
        id: checkov-terraform
        run: |
          pip install checkov

          echo "Running Checkov security scan on Terraform..."
          checkov -d infra/terraform --framework terraform \
            --output json --output-file checkov-terraform-results.json \
            --soft-fail || echo "checkov_failed=true" >> $GITHUB_OUTPUT

          if [ -f checkov-terraform-results.json ]; then
            FAILED_CHECKS=$(jq '.results.failed_checks | length' checkov-terraform-results.json 2>/dev/null || echo "0")
            PASSED_CHECKS=$(jq '.results.passed_checks | length' checkov-terraform-results.json 2>/dev/null || echo "0")

            echo "checkov_failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
            echo "checkov_passed_checks=$PASSED_CHECKS" >> $GITHUB_OUTPUT

            # Generate summary
            echo "" >> terraform-security-report.md
            echo "### Checkov Policy Compliance" >> terraform-security-report.md
            echo "- ‚úÖ Passed Checks: $PASSED_CHECKS" >> terraform-security-report.md
            echo "- ‚ùå Failed Checks: $FAILED_CHECKS" >> terraform-security-report.md
          fi

      - name: Run TFSec security scan
        id: tfsec
        run: |
          # Install tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

          echo "Running tfsec security scan..."
          tfsec infra/terraform --format json --out tfsec-results.json \
            --soft-fail || echo "tfsec_failed=true" >> $GITHUB_OUTPUT

          if [ -f tfsec-results.json ]; then
            TFSEC_ISSUES=$(jq '.results | length' tfsec-results.json 2>/dev/null || echo "0")
            echo "tfsec_issues=$TFSEC_ISSUES" >> $GITHUB_OUTPUT

            echo "" >> terraform-security-report.md
            echo "### TFSec Security Issues" >> terraform-security-report.md
            echo "- Issues Found: $TFSEC_ISSUES" >> terraform-security-report.md
          fi

      - name: Upload Terraform security results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-terraform-results.sarif'
          category: 'terraform-security'

      - name: Upload Terraform security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-security-results-${{ github.run_id }}
          path: |
            trivy-terraform-results.json
            checkov-terraform-results.json
            tfsec-results.json
            terraform-security-report.md
          retention-days: 30

      - name: Comment PR with Terraform security results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportContent = '';
            try {
              reportContent = fs.readFileSync('terraform-security-report.md', 'utf8');
            } catch (error) {
              reportContent = '‚ùå Security scan report not available';
            }

            const commentBody = `## üîí Terraform Security Scan Results

            ${reportContent}

            <details>
            <summary>üìã View Detailed Results</summary>

            **Scan Details:**
            - Trivy Critical: ${{ steps.trivy-terraform.outputs.trivy_critical || '0' }}
            - Trivy High: ${{ steps.trivy-terraform.outputs.trivy_high || '0' }}
            - Trivy Medium: ${{ steps.trivy-terraform.outputs.trivy_medium || '0' }}
            - Checkov Failed: ${{ steps.checkov-terraform.outputs.checkov_failed_checks || '0' }}
            - Checkov Passed: ${{ steps.checkov-terraform.outputs.checkov_passed_checks || '0' }}
            - TFSec Issues: ${{ steps.tfsec.outputs.tfsec_issues || '0' }}

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            </details>

            ---
            *Automatically generated by Security Scanning workflow*`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Terraform Security Scan Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  container-security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || inputs.scan_type == 'all' || inputs.scan_type == 'containers'

    strategy:
      matrix:
        service:
          [
            api,
            worker,
            router,
            ocr,
            structure,
            tagger,
            exporter,
            validator,
            notifier,
          ]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine service path
        id: service-path
        run: |
          if [ -d "services/functions/${{ matrix.service }}" ]; then
            SERVICE_PATH="services/functions/${{ matrix.service }}"
          elif [ -d "services/${{ matrix.service }}" ]; then
            SERVICE_PATH="services/${{ matrix.service }}"
          else
            echo "Service directory not found for ${{ matrix.service }}"
            exit 1
          fi
          echo "path=$SERVICE_PATH" >> $GITHUB_OUTPUT

      - name: Build container image for scanning
        id: build
        run: |
          SERVICE_PATH="${{ steps.service-path.outputs.path }}"
          IMAGE_NAME="security-scan-${{ matrix.service }}:latest"

          echo "Building image for security scanning: $IMAGE_NAME"
          docker build -t "$IMAGE_NAME" "$SERVICE_PATH"
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Run Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.build.outputs.image_name }}
          format: 'sarif'
          output: 'trivy-container-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Run Trivy container scan with JSON output
        id: trivy-container
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$PWD:/workspace" aquasec/trivy image \
            --format json --output /workspace/trivy-container-${{ matrix.service }}.json \
            --severity CRITICAL,HIGH,MEDIUM \
            ${{ steps.build.outputs.image_name }} || echo "trivy_failed=true" >> $GITHUB_OUTPUT

          if [ -f trivy-container-${{ matrix.service }}.json ]; then
            # Count vulnerabilities by severity
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-container-${{ matrix.service }}.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-container-${{ matrix.service }}.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' trivy-container-${{ matrix.service }}.json 2>/dev/null || echo "0")

            echo "trivy_critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "trivy_high=$HIGH" >> $GITHUB_OUTPUT
            echo "trivy_medium=$MEDIUM" >> $GITHUB_OUTPUT

            # Generate report
            echo "## Container Security Scan - ${{ matrix.service }}" > container-security-${{ matrix.service }}.md
            echo "" >> container-security-${{ matrix.service }}.md
            echo "| Severity | Count |" >> container-security-${{ matrix.service }}.md
            echo "|----------|-------|" >> container-security-${{ matrix.service }}.md
            echo "| Critical | $CRITICAL |" >> container-security-${{ matrix.service }}.md
            echo "| High | $HIGH |" >> container-security-${{ matrix.service }}.md
            echo "| Medium | $MEDIUM |" >> container-security-${{ matrix.service }}.md
          fi

      - name: Upload container security results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-container-${{ matrix.service }}.sarif'
          category: 'container-security-${{ matrix.service }}'

      - name: Upload container security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: container-security-${{ matrix.service }}-${{ github.run_id }}
          path: |
            trivy-container-${{ matrix.service }}.json
            container-security-${{ matrix.service }}.md
          retention-days: 30

  dependency-security-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || inputs.scan_type == 'all' || inputs.scan_type == 'dependencies'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Scan Python dependencies with Safety
        id: safety-scan
        run: |
          pip install safety

          echo "Running Safety scan on Python dependencies..."

          # Scan root requirements
          if [ -f requirements-dev.txt ]; then
            safety check -r requirements-dev.txt --json --output safety-root.json || echo "safety_root_failed=true" >> $GITHUB_OUTPUT
          fi

          # Scan API service requirements
          if [ -f services/api/requirements.txt ]; then
            safety check -r services/api/requirements.txt --json --output safety-api.json || echo "safety_api_failed=true" >> $GITHUB_OUTPUT
          fi

          # Scan function services
          for service_dir in services/functions/*/; do
            if [ -f "$service_dir/requirements.txt" ]; then
              service_name=$(basename "$service_dir")
              safety check -r "$service_dir/requirements.txt" --json --output "safety-$service_name.json" || echo "safety_${service_name}_failed=true" >> $GITHUB_OUTPUT
            fi
          done

          # Generate summary report
          echo "## Python Dependency Security Scan" > dependency-security-report.md
          echo "" >> dependency-security-report.md

          TOTAL_VULNERABILITIES=0
          for safety_file in safety-*.json; do
            if [ -f "$safety_file" ]; then
              VULNS=$(jq '. | length' "$safety_file" 2>/dev/null || echo "0")
              TOTAL_VULNERABILITIES=$((TOTAL_VULNERABILITIES + VULNS))
              SERVICE_NAME=$(echo "$safety_file" | sed 's/safety-//;s/.json//')
              echo "- **$SERVICE_NAME**: $VULNS vulnerabilities" >> dependency-security-report.md
            fi
          done

          echo "python_vulnerabilities=$TOTAL_VULNERABILITIES" >> $GITHUB_OUTPUT
          echo "" >> dependency-security-report.md
          echo "**Total Python Vulnerabilities:** $TOTAL_VULNERABILITIES" >> dependency-security-report.md

      - name: Scan Python dependencies with pip-audit
        id: pip-audit-scan
        run: |
          pip install pip-audit

          echo "Running pip-audit scan..."

          # Create combined requirements file for comprehensive scan
          cat > combined-requirements.txt << EOF
          # Combined requirements for security scanning
          EOF

          if [ -f requirements-dev.txt ]; then
            echo "# Root requirements" >> combined-requirements.txt
            cat requirements-dev.txt >> combined-requirements.txt
          fi

          if [ -f services/api/requirements.txt ]; then
            echo "# API requirements" >> combined-requirements.txt
            cat services/api/requirements.txt >> combined-requirements.txt
          fi

          # Add function requirements
          for service_dir in services/functions/*/; do
            if [ -f "$service_dir/requirements.txt" ]; then
              service_name=$(basename "$service_dir")
              echo "# $service_name requirements" >> combined-requirements.txt
              cat "$service_dir/requirements.txt" >> combined-requirements.txt
            fi
          done

          pip-audit --requirement combined-requirements.txt --format json --output pip-audit-results.json || echo "pip_audit_failed=true" >> $GITHUB_OUTPUT

          if [ -f pip-audit-results.json ]; then
            PIP_AUDIT_VULNS=$(jq '. | length' pip-audit-results.json 2>/dev/null || echo "0")
            echo "pip_audit_vulnerabilities=$PIP_AUDIT_VULNS" >> $GITHUB_OUTPUT

            echo "" >> dependency-security-report.md
            echo "### pip-audit Results" >> dependency-security-report.md
            echo "- **Vulnerabilities Found:** $PIP_AUDIT_VULNS" >> dependency-security-report.md
          fi

      - name: Scan Node.js dependencies
        id: npm-audit
        run: |
          cd web

          echo "Installing dependencies..."
          pnpm install --frozen-lockfile

          echo "Running npm audit..."
          pnpm audit --json > ../npm-audit-results.json || echo "npm_audit_failed=true" >> $GITHUB_OUTPUT

          cd ..

          if [ -f npm-audit-results.json ]; then
            # Parse npm audit results
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json 2>/dev/null || echo "0")
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit-results.json 2>/dev/null || echo "0")
            LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit-results.json 2>/dev/null || echo "0")

            echo "npm_critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "npm_high=$HIGH" >> $GITHUB_OUTPUT
            echo "npm_moderate=$MODERATE" >> $GITHUB_OUTPUT
            echo "npm_low=$LOW" >> $GITHUB_OUTPUT

            echo "" >> dependency-security-report.md
            echo "### Node.js Dependency Security Scan" >> dependency-security-report.md
            echo "| Severity | Count |" >> dependency-security-report.md
            echo "|----------|-------|" >> dependency-security-report.md
            echo "| Critical | $CRITICAL |" >> dependency-security-report.md
            echo "| High | $HIGH |" >> dependency-security-report.md
            echo "| Moderate | $MODERATE |" >> dependency-security-report.md
            echo "| Low | $LOW |" >> dependency-security-report.md
          fi

      - name: Upload dependency security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-results-${{ github.run_id }}
          path: |
            safety-*.json
            pip-audit-results.json
            npm-audit-results.json
            dependency-security-report.md
            combined-requirements.txt
          retention-days: 30

  sast-scan:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || inputs.scan_type == 'all' || inputs.scan_type == 'sast'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run Bandit SAST for Python
        id: bandit-scan
        run: |
          pip install bandit[toml]

          echo "Running Bandit SAST scan on Python code..."

          # Scan API service
          if [ -d services/api ]; then
            bandit -r services/api -f json -o bandit-api.json || echo "bandit_api_failed=true" >> $GITHUB_OUTPUT
          fi

          # Scan function services
          for service_dir in services/functions/*/; do
            if [ -d "$service_dir" ]; then
              service_name=$(basename "$service_dir")
              bandit -r "$service_dir" -f json -o "bandit-$service_name.json" || echo "bandit_${service_name}_failed=true" >> $GITHUB_OUTPUT
            fi
          done

          # Scan worker service
          if [ -d services/worker ]; then
            bandit -r services/worker -f json -o bandit-worker.json || echo "bandit_worker_failed=true" >> $GITHUB_OUTPUT
          fi

          # Generate summary
          echo "## SAST Security Scan Results" > sast-security-report.md
          echo "" >> sast-security-report.md
          echo "### Bandit Python SAST Results" >> sast-security-report.md

          TOTAL_ISSUES=0
          for bandit_file in bandit-*.json; do
            if [ -f "$bandit_file" ]; then
              ISSUES=$(jq '.results | length' "$bandit_file" 2>/dev/null || echo "0")
              TOTAL_ISSUES=$((TOTAL_ISSUES + ISSUES))
              SERVICE_NAME=$(echo "$bandit_file" | sed 's/bandit-//;s/.json//')
              echo "- **$SERVICE_NAME**: $ISSUES issues" >> sast-security-report.md
            fi
          done

          echo "bandit_total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "" >> sast-security-report.md
          echo "**Total Bandit Issues:** $TOTAL_ISSUES" >> sast-security-report.md

      - name: Run Semgrep SAST
        id: semgrep-scan
        run: |
          pip install semgrep

          echo "Running Semgrep SAST scan..."

          semgrep --config=auto --json --output=semgrep-results.json . || echo "semgrep_failed=true" >> $GITHUB_OUTPUT

          if [ -f semgrep-results.json ]; then
            SEMGREP_ISSUES=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "semgrep_issues=$SEMGREP_ISSUES" >> $GITHUB_OUTPUT

            echo "" >> sast-security-report.md
            echo "### Semgrep SAST Results" >> sast-security-report.md
            echo "- **Issues Found:** $SEMGREP_ISSUES" >> sast-security-report.md
          fi

      - name: Run ESLint security rules for JavaScript/TypeScript
        id: eslint-security
        run: |
          cd web

          echo "Running ESLint with security rules..."

          # Install security-focused ESLint plugins
          pnpm add --save-dev eslint-plugin-security @typescript-eslint/eslint-plugin

          # Create security-focused ESLint config
          cat > .eslintrc.security.js << 'EOF'
          module.exports = {
            extends: [
              './.eslintrc.js',
              'plugin:security/recommended'
            ],
            plugins: ['security'],
            rules: {
              'security/detect-object-injection': 'error',
              'security/detect-non-literal-regexp': 'error',
              'security/detect-unsafe-regex': 'error',
              'security/detect-buffer-noassert': 'error',
              'security/detect-child-process': 'error',
              'security/detect-disable-mustache-escape': 'error',
              'security/detect-eval-with-expression': 'error',
              'security/detect-no-csrf-before-method-override': 'error',
              'security/detect-non-literal-fs-filename': 'error',
              'security/detect-non-literal-require': 'error',
              'security/detect-possible-timing-attacks': 'error',
              'security/detect-pseudoRandomBytes': 'error'
            }
          };
          EOF

          npx eslint . --config .eslintrc.security.js --format json --output-file ../eslint-security-results.json || echo "eslint_security_failed=true" >> $GITHUB_OUTPUT

          cd ..

          if [ -f eslint-security-results.json ]; then
            ESLINT_ISSUES=$(jq '. | length' eslint-security-results.json 2>/dev/null || echo "0")
            echo "eslint_security_issues=$ESLINT_ISSUES" >> $GITHUB_OUTPUT

            echo "" >> sast-security-report.md
            echo "### ESLint Security Results" >> sast-security-report.md
            echo "- **Security Issues Found:** $ESLINT_ISSUES" >> sast-security-report.md
          fi

      - name: Upload SAST security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-security-results-${{ github.run_id }}
          path: |
            bandit-*.json
            semgrep-results.json
            eslint-security-results.json
            sast-security-report.md
          retention-days: 30

  compliance-checks:
    name: Compliance Checks
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || inputs.scan_type == 'all' || inputs.scan_type == 'compliance'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Run WCAG accessibility compliance checks
        id: wcag-compliance
        run: |
          cd web

          echo "Installing accessibility testing tools..."
          pnpm add --save-dev @axe-core/cli pa11y lighthouse

          echo "Building web application for accessibility testing..."
          pnpm install --frozen-lockfile
          pnpm build

          # Start the application for testing
          pnpm start &
          APP_PID=$!

          # Wait for application to start
          sleep 30

          echo "Running axe-core accessibility tests..."
          npx axe http://localhost:3000 --save ../axe-results.json || echo "axe_failed=true" >> $GITHUB_OUTPUT

          echo "Running pa11y accessibility tests..."
          npx pa11y http://localhost:3000 --reporter json > ../pa11y-results.json || echo "pa11y_failed=true" >> $GITHUB_OUTPUT

          echo "Running Lighthouse accessibility audit..."
          npx lighthouse http://localhost:3000 --only-categories=accessibility --output=json --output-path=../lighthouse-accessibility.json || echo "lighthouse_failed=true" >> $GITHUB_OUTPUT

          # Stop the application
          kill $APP_PID

          cd ..

          # Generate compliance report
          echo "## WCAG Compliance Check Results" > compliance-report.md
          echo "" >> compliance-report.md

          if [ -f axe-results.json ]; then
            AXE_VIOLATIONS=$(jq '.violations | length' axe-results.json 2>/dev/null || echo "0")
            echo "axe_violations=$AXE_VIOLATIONS" >> $GITHUB_OUTPUT
            echo "### Axe-core Results" >> compliance-report.md
            echo "- **Violations Found:** $AXE_VIOLATIONS" >> compliance-report.md
          fi

          if [ -f pa11y-results.json ]; then
            PA11Y_ISSUES=$(jq '. | length' pa11y-results.json 2>/dev/null || echo "0")
            echo "pa11y_issues=$PA11Y_ISSUES" >> $GITHUB_OUTPUT
            echo "### Pa11y Results" >> compliance-report.md
            echo "- **Issues Found:** $PA11Y_ISSUES" >> compliance-report.md
          fi

          if [ -f lighthouse-accessibility.json ]; then
            LIGHTHOUSE_SCORE=$(jq '.lhr.categories.accessibility.score * 100' lighthouse-accessibility.json 2>/dev/null || echo "0")
            echo "lighthouse_accessibility_score=$LIGHTHOUSE_SCORE" >> $GITHUB_OUTPUT
            echo "### Lighthouse Accessibility Score" >> compliance-report.md
            echo "- **Score:** ${LIGHTHOUSE_SCORE}%" >> compliance-report.md
          fi

      - name: Run security compliance checks
        id: security-compliance
        run: |
          echo "" >> compliance-report.md
          echo "### Security Compliance Checks" >> compliance-report.md

          # Check for security headers in web application
          echo "Checking security headers configuration..."

          # Check Next.js security configuration
          if [ -f web/next.config.js ]; then
            if grep -q "contentSecurityPolicy\|frameOptions\|referrerPolicy" web/next.config.js; then
              echo "- ‚úÖ Security headers configured in Next.js" >> compliance-report.md
            else
              echo "- ‚ùå Security headers not found in Next.js config" >> compliance-report.md
            fi
          fi

          # Check for HTTPS enforcement
          if grep -q "https" web/next.config.js || grep -q "secure" web/next.config.js; then
            echo "- ‚úÖ HTTPS enforcement configured" >> compliance-report.md
          else
            echo "- ‚ö†Ô∏è HTTPS enforcement not explicitly configured" >> compliance-report.md
          fi

          # Check for environment variable security
          if [ -f .env.example ] || [ -f web/.env.example ]; then
            echo "- ‚úÖ Environment variable examples provided" >> compliance-report.md
          else
            echo "- ‚ö†Ô∏è No environment variable examples found" >> compliance-report.md
          fi

          # Check for secrets in code
          echo "Scanning for potential secrets in code..."
          SECRET_PATTERNS="password|secret|key|token|api_key|private_key"
          SECRET_MATCHES=$(grep -r -i -E "$SECRET_PATTERNS" --include="*.py" --include="*.js" --include="*.ts" --include="*.json" . | grep -v ".git" | grep -v "node_modules" | grep -v "__pycache__" | wc -l || echo "0")

          if [ "$SECRET_MATCHES" -gt 0 ]; then
            echo "- ‚ö†Ô∏è Potential secrets found in code: $SECRET_MATCHES matches" >> compliance-report.md
          else
            echo "- ‚úÖ No obvious secrets found in code" >> compliance-report.md
          fi

      - name: Upload compliance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-results-${{ github.run_id }}
          path: |
            axe-results.json
            pa11y-results.json
            lighthouse-accessibility.json
            compliance-report.md
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        terraform-security-scan,
        container-security-scan,
        dependency-security-scan,
        sast-scan,
        compliance-checks,
      ]
    if: always()

    steps:
      - name: Download all security artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-results

      - name: Generate comprehensive security report
        run: |
          echo "# üîí Comprehensive Security Scan Report" > security-summary.md
          echo "" >> security-summary.md
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-summary.md
          echo "**Repository:** ${{ github.repository }}" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "**Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> security-summary.md
          echo "" >> security-summary.md

          # Terraform Security Summary
          echo "## üèóÔ∏è Infrastructure Security (Terraform)" >> security-summary.md
          echo "| Tool | Status | Critical | High | Medium |" >> security-summary.md
          echo "|------|--------|----------|------|--------|" >> security-summary.md

          TERRAFORM_STATUS="‚úÖ Passed"
          if [ "${{ needs.terraform-security-scan.outputs.trivy_critical || '0' }}" -gt 0 ] || [ "${{ needs.terraform-security-scan.outputs.trivy_high || '0' }}" -gt 0 ]; then
            TERRAFORM_STATUS="‚ùå Issues Found"
          fi

          echo "| Trivy | $TERRAFORM_STATUS | ${{ needs.terraform-security-scan.outputs.trivy_critical || '0' }} | ${{ needs.terraform-security-scan.outputs.trivy_high || '0' }} | ${{ needs.terraform-security-scan.outputs.trivy_medium || '0' }} |" >> security-summary.md
          echo "| Checkov | ${{ needs.terraform-security-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | - | - | ${{ needs.terraform-security-scan.outputs.checkov_failed_checks || '0' }} |" >> security-summary.md
          echo "| TFSec | ${{ needs.terraform-security-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | - | - | ${{ needs.terraform-security-scan.outputs.tfsec_issues || '0' }} |" >> security-summary.md
          echo "" >> security-summary.md

          # Container Security Summary
          echo "## üê≥ Container Security" >> security-summary.md
          echo "| Service | Status | Critical | High | Medium |" >> security-summary.md
          echo "|---------|--------|----------|------|--------|" >> security-summary.md

          # Note: Container results would need to be aggregated from matrix job outputs
          echo "| All Services | ${{ needs.container-security-scan.result == 'success' && '‚úÖ Scanned' || '‚ùå Failed' }} | See detailed results | See detailed results | See detailed results |" >> security-summary.md
          echo "" >> security-summary.md

          # Dependency Security Summary
          echo "## üì¶ Dependency Security" >> security-summary.md
          echo "| Language | Tool | Status | Vulnerabilities |" >> security-summary.md
          echo "|----------|------|--------|-----------------|" >> security-summary.md
          echo "| Python | Safety | ${{ needs.dependency-security-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | ${{ needs.dependency-security-scan.outputs.python_vulnerabilities || '0' }} |" >> security-summary.md
          echo "| Python | pip-audit | ${{ needs.dependency-security-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | ${{ needs.dependency-security-scan.outputs.pip_audit_vulnerabilities || '0' }} |" >> security-summary.md
          echo "| Node.js | npm audit | ${{ needs.dependency-security-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | Critical: ${{ needs.dependency-security-scan.outputs.npm_critical || '0' }}, High: ${{ needs.dependency-security-scan.outputs.npm_high || '0' }} |" >> security-summary.md
          echo "" >> security-summary.md

          # SAST Summary
          echo "## üîç Static Application Security Testing (SAST)" >> security-summary.md
          echo "| Tool | Status | Issues Found |" >> security-summary.md
          echo "|------|--------|--------------|" >> security-summary.md
          echo "| Bandit (Python) | ${{ needs.sast-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | ${{ needs.sast-scan.outputs.bandit_total_issues || '0' }} |" >> security-summary.md
          echo "| Semgrep | ${{ needs.sast-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | ${{ needs.sast-scan.outputs.semgrep_issues || '0' }} |" >> security-summary.md
          echo "| ESLint Security | ${{ needs.sast-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | ${{ needs.sast-scan.outputs.eslint_security_issues || '0' }} |" >> security-summary.md
          echo "" >> security-summary.md

          # Compliance Summary
          echo "## ‚úÖ Compliance Checks" >> security-summary.md
          echo "| Check Type | Status | Score/Issues |" >> security-summary.md
          echo "|------------|--------|--------------|" >> security-summary.md
          echo "| WCAG (Axe-core) | ${{ needs.compliance-checks.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | ${{ needs.compliance-checks.outputs.axe_violations || '0' }} violations |" >> security-summary.md
          echo "| WCAG (Pa11y) | ${{ needs.compliance-checks.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | ${{ needs.compliance-checks.outputs.pa11y_issues || '0' }} issues |" >> security-summary.md
          echo "| Lighthouse Accessibility | ${{ needs.compliance-checks.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} | ${{ needs.compliance-checks.outputs.lighthouse_accessibility_score || '0' }}% |" >> security-summary.md
          echo "" >> security-summary.md

          # Overall Security Status
          echo "## üéØ Overall Security Status" >> security-summary.md

          CRITICAL_ISSUES=0
          HIGH_ISSUES=0

          # Calculate total critical and high issues
          TERRAFORM_CRITICAL=${{ needs.terraform-security-scan.outputs.trivy_critical || '0' }}
          TERRAFORM_HIGH=${{ needs.terraform-security-scan.outputs.trivy_high || '0' }}

          CRITICAL_ISSUES=$((CRITICAL_ISSUES + TERRAFORM_CRITICAL))
          HIGH_ISSUES=$((HIGH_ISSUES + TERRAFORM_HIGH))

          if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo "üö® **CRITICAL**: $CRITICAL_ISSUES critical security issues found. Immediate action required!" >> security-summary.md
          elif [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "‚ö†Ô∏è **HIGH**: $HIGH_ISSUES high severity issues found. Review and remediate soon." >> security-summary.md
          else
            echo "‚úÖ **GOOD**: No critical or high severity security issues found." >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "### Recommendations" >> security-summary.md
          echo "1. Review all security scan results in the Security tab" >> security-summary.md
          echo "2. Address critical and high severity issues first" >> security-summary.md
          echo "3. Update dependencies with known vulnerabilities" >> security-summary.md
          echo "4. Ensure WCAG compliance for accessibility" >> security-summary.md
          echo "5. Implement security headers and best practices" >> security-summary.md

      - name: Upload comprehensive security report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-report-${{ github.run_id }}
          path: security-summary.md
          retention-days: 90

      - name: Comment PR with security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportContent = '';
            try {
              reportContent = fs.readFileSync('security-summary.md', 'utf8');
            } catch (error) {
              reportContent = '‚ùå Security summary report not available';
            }

            const commentBody = `## üîí Security Scan Summary

            ${reportContent}

            ---
            *Automatically generated by Security Scanning workflow*`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Security Scan Summary')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Generate step summary
        run: |
          cat security-summary.md >> $GITHUB_STEP_SUMMARY
