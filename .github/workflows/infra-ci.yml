name: Infrastructure CI

on:
  pull_request:
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/infra-ci.yml'
  push:
    branches: [main]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/infra-ci.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      dry_run:
        description: 'Perform dry run (plan only)'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  TF_VERSION: '1.5.7'
  TF_WORKING_DIR: 'infra/terraform'

jobs:
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    outputs:
      tf_fmt_check: ${{ steps.fmt.outcome }}
      tf_validate_check: ${{ steps.validate.outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform validate

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    outputs:
      plan_outcome: ${{ steps.plan.outcome }}
      plan_summary: ${{ steps.plan-summary.outputs.summary }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_INFRASTRUCTURE_CI_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-InfraCI-Plan-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        id: init
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform plan -detailed-exitcode -out=tfplan 2>&1 | tee plan_output.txt
          echo "plan_exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate Plan Summary
        id: plan-summary
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          # Extract key information from plan output
          if [ -f plan_output.txt ]; then
            # Count resources
            TO_ADD=$(grep -c "will be created" plan_output.txt || echo "0")
            TO_CHANGE=$(grep -c "will be updated" plan_output.txt || echo "0")
            TO_DESTROY=$(grep -c "will be destroyed" plan_output.txt || echo "0")

            # Check for destructive changes
            DESTRUCTIVE_CHANGES=""
            if [ "$TO_DESTROY" -gt 0 ]; then
              DESTRUCTIVE_CHANGES="‚ö†Ô∏è **WARNING: This plan includes destructive changes!**\n\n"
              DESTRUCTIVE_CHANGES+="Resources to be destroyed:\n"
              grep -A 1 "will be destroyed" plan_output.txt | grep -E "^[[:space:]]*#" | head -10 >> destructive_changes.txt || true
              if [ -f destructive_changes.txt ]; then
                DESTRUCTIVE_CHANGES+="$(cat destructive_changes.txt)\n"
              fi
            fi

            # Create summary
            SUMMARY="## Terraform Plan Summary\n\n"
            SUMMARY+="$DESTRUCTIVE_CHANGES"
            SUMMARY+="üìä **Resource Changes:**\n"
            SUMMARY+="- üü¢ To Add: $TO_ADD\n"
            SUMMARY+="- üü° To Change: $TO_CHANGE\n"
            SUMMARY+="- üî¥ To Destroy: $TO_DESTROY\n\n"

            if [ "${{ steps.plan.outputs.plan_exitcode }}" -eq 0 ]; then
              SUMMARY+="‚úÖ **Plan Status:** No changes detected\n"
            elif [ "${{ steps.plan.outputs.plan_exitcode }}" -eq 2 ]; then
              SUMMARY+="üìã **Plan Status:** Changes detected\n"
            else
              SUMMARY+="‚ùå **Plan Status:** Plan failed\n"
            fi

            # Add validation results
            SUMMARY+="\n## Validation Results\n"
            if [ "${{ needs.terraform-validate.outputs.tf_fmt_check }}" == "success" ]; then
              SUMMARY+="‚úÖ Terraform Format: Passed\n"
            else
              SUMMARY+="‚ùå Terraform Format: Failed\n"
            fi

            if [ "${{ needs.terraform-validate.outputs.tf_validate_check }}" == "success" ]; then
              SUMMARY+="‚úÖ Terraform Validate: Passed\n"
            else
              SUMMARY+="‚ùå Terraform Validate: Failed\n"
            fi

            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo -e "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=‚ùå Plan output not found" >> $GITHUB_OUTPUT
          fi

      - name: Upload Plan Artifact
        if: steps.plan.outputs.plan_exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_id }}
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/plan_output.txt
          retention-days: 30

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-plan]
    if: github.event_name == 'pull_request'

    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ needs.terraform-plan.outputs.plan_summary }}`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Terraform Plan Summary')
            );

            const commentBody = `${summary}

            <details>
            <summary>üìã View Full Plan Output</summary>

            \`\`\`
            Plan generated at: ${{ github.event.pull_request.head.sha }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            \`\`\`

            </details>

            ---
            *Automatically generated by Infrastructure CI workflow*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-plan]
    if: |
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' ||
       (github.event_name == 'workflow_dispatch' && !inputs.dry_run))
    environment:
      name: production-infrastructure
      url: ${{ steps.apply.outputs.web_app_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_INFRASTRUCTURE_CI_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-InfraCI-Apply-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        id: init
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform init

      - name: Download Plan Artifact (if available)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Terraform Apply
        id: apply
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          if [ -f tfplan ] && [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Applying existing plan..."
            terraform apply tfplan
          else
            echo "Creating new plan and applying..."
            terraform apply -auto-approve
          fi

          # Capture outputs
          WEB_APP_URL=$(terraform output -raw web_app_url 2>/dev/null || echo "")
          API_GATEWAY_URL=$(terraform output -raw api_gateway_url 2>/dev/null || echo "")

          echo "web_app_url=$WEB_APP_URL" >> $GITHUB_OUTPUT
          echo "api_gateway_url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT

      - name: Generate Deployment Summary
        id: summary
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          echo "## üöÄ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- üåç Environment: ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- üìÖ Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- üîó Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.apply.outputs.web_app_url }}" ]; then
            echo "**Application URLs:**" >> $GITHUB_STEP_SUMMARY
            echo "- üåê Web App: ${{ steps.apply.outputs.web_app_url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ steps.apply.outputs.api_gateway_url }}" ]; then
            echo "- üîå API Gateway: ${{ steps.apply.outputs.api_gateway_url }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Summary:**" >> $GITHUB_STEP_SUMMARY

          # Get resource counts from state
          RESOURCE_COUNT=$(terraform state list | wc -l)
          echo "- üì¶ Total Resources: $RESOURCE_COUNT" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'infra/terraform'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Generate Security Summary
        run: |
          echo "## üîí Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Trivy security scan completed for Terraform configuration." >> $GITHUB_STEP_SUMMARY
          echo "Check the Security tab for detailed results." >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [terraform-apply]
    if: always() && needs.terraform-apply.result != 'skipped'

    steps:
      - name: Notify Success
        if: needs.terraform-apply.result == 'success'
        run: |
          echo "‚úÖ Infrastructure deployment completed successfully"
          echo "Web App URL: ${{ needs.terraform-apply.outputs.web_app_url }}"
          # Add Slack/Teams notification here if configured

      - name: Notify Failure
        if: needs.terraform-apply.result == 'failure'
        run: |
          echo "‚ùå Infrastructure deployment failed"
          echo "Check the workflow logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add Slack/Teams notification here if configured
          exit 1
