name: Infrastructure CI

on:
  pull_request:
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/infra-ci.yml'
  push:
    branches: [main]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/infra-ci.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      dry_run:
        description: 'Perform dry run (plan only)'
        required: false
        default: false
        type: boolean
      emergency_deployment:
        description: 'Emergency deployment (bypasses some checks for non-prod)'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  TF_VERSION: '1.5.7'
  TF_WORKING_DIR: 'infra/terraform'

jobs:
  setup-environment:
    name: Setup Environment Configuration
    runs-on: ubuntu-latest
    outputs:
      require_approval: ${{ steps.env-config.outputs.require_approval }}
      security_threshold: ${{ steps.env-config.outputs.security_threshold }}
      deployment_strategy: ${{ steps.env-config.outputs.deployment_strategy }}
      resource_prefix: ${{ steps.env-config.outputs.resource_prefix }}
      notification_config: ${{ steps.env-config.outputs.notification_config }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment configuration
        id: env-config
        uses: ./.github/actions/setup-environment
        with:
          environment: ${{ inputs.environment || 'prod' }}

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    outputs:
      tf_fmt_check: ${{ steps.fmt.outcome }}
      tf_validate_check: ${{ steps.validate.outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform validate

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [setup-environment, terraform-validate]
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    outputs:
      plan_outcome: ${{ steps.plan.outcome }}
      plan_summary: ${{ steps.plan-summary.outputs.summary }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_INFRASTRUCTURE_CI_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-InfraCI-Plan-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        id: init
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform plan -detailed-exitcode -out=tfplan 2>&1 | tee plan_output.txt
          echo "plan_exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate Plan Summary
        id: plan-summary
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          # Extract key information from plan output
          if [ -f plan_output.txt ]; then
            # Count resources
            TO_ADD=$(grep -c "will be created" plan_output.txt || echo "0")
            TO_CHANGE=$(grep -c "will be updated" plan_output.txt || echo "0")
            TO_DESTROY=$(grep -c "will be destroyed" plan_output.txt || echo "0")

            # Check for destructive changes
            DESTRUCTIVE_CHANGES=""
            if [ "$TO_DESTROY" -gt 0 ]; then
              DESTRUCTIVE_CHANGES="âš ï¸ **WARNING: This plan includes destructive changes!**\n\n"
              DESTRUCTIVE_CHANGES+="Resources to be destroyed:\n"
              grep -A 1 "will be destroyed" plan_output.txt | grep -E "^[[:space:]]*#" | head -10 >> destructive_changes.txt || true
              if [ -f destructive_changes.txt ]; then
                DESTRUCTIVE_CHANGES+="$(cat destructive_changes.txt)\n"
              fi
            fi

            # Create summary
            SUMMARY="## Terraform Plan Summary\n\n"
            SUMMARY+="$DESTRUCTIVE_CHANGES"
            SUMMARY+="ğŸ“Š **Resource Changes:**\n"
            SUMMARY+="- ğŸŸ¢ To Add: $TO_ADD\n"
            SUMMARY+="- ğŸŸ¡ To Change: $TO_CHANGE\n"
            SUMMARY+="- ğŸ”´ To Destroy: $TO_DESTROY\n\n"

            if [ "${{ steps.plan.outputs.plan_exitcode }}" -eq 0 ]; then
              SUMMARY+="âœ… **Plan Status:** No changes detected\n"
            elif [ "${{ steps.plan.outputs.plan_exitcode }}" -eq 2 ]; then
              SUMMARY+="ğŸ“‹ **Plan Status:** Changes detected\n"
            else
              SUMMARY+="âŒ **Plan Status:** Plan failed\n"
            fi

            # Add validation results
            SUMMARY+="\n## Validation Results\n"
            if [ "${{ needs.terraform-validate.outputs.tf_fmt_check }}" == "success" ]; then
              SUMMARY+="âœ… Terraform Format: Passed\n"
            else
              SUMMARY+="âŒ Terraform Format: Failed\n"
            fi

            if [ "${{ needs.terraform-validate.outputs.tf_validate_check }}" == "success" ]; then
              SUMMARY+="âœ… Terraform Validate: Passed\n"
            else
              SUMMARY+="âŒ Terraform Validate: Failed\n"
            fi

            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo -e "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=âŒ Plan output not found" >> $GITHUB_OUTPUT
          fi

      - name: Upload Plan Artifact
        if: steps.plan.outputs.plan_exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_id }}
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/plan_output.txt
          retention-days: 30

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-plan]
    if: github.event_name == 'pull_request'

    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ needs.terraform-plan.outputs.plan_summary }}`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Terraform Plan Summary')
            );

            const commentBody = `${summary}

            <details>
            <summary>ğŸ“‹ View Full Plan Output</summary>

            \`\`\`
            Plan generated at: ${{ github.event.pull_request.head.sha }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            \`\`\`

            </details>

            ---
            *Automatically generated by Infrastructure CI workflow*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  environment-gate:
    name: Environment Deployment Gate
    runs-on: ubuntu-latest
    needs:
      [
        setup-environment,
        terraform-validate,
        terraform-plan,
        terraform-test,
        security-scan,
      ]
    if: |
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' ||
       (github.event_name == 'workflow_dispatch' && !inputs.dry_run))
    outputs:
      gate_passed: ${{ steps.gate.outputs.gate_passed }}
      approval_required: ${{ steps.gate.outputs.approval_required }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run environment gate
        id: gate
        uses: ./.github/actions/environment-gate
        with:
          environment: ${{ inputs.environment || 'prod' }}
          require_approval: ${{ needs.setup-environment.outputs.require_approval }}
          security_threshold: ${{ needs.setup-environment.outputs.security_threshold }}
          deployment_type: 'infrastructure'

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs:
      [
        setup-environment,
        terraform-validate,
        terraform-plan,
        terraform-test,
        environment-gate,
      ]
    if: |
      needs.environment-gate.outputs.gate_passed == 'true' &&
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' ||
       (github.event_name == 'workflow_dispatch' && !inputs.dry_run))
    environment:
      name: ${{ inputs.environment || 'prod' }}-infrastructure
      url: ${{ steps.apply.outputs.web_app_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_INFRASTRUCTURE_CI_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-InfraCI-Apply-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        id: init
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          terraform init

      - name: Download Plan Artifact (if available)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Terraform Apply
        id: apply
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          if [ -f tfplan ] && [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Applying existing plan..."
            terraform apply tfplan
          else
            echo "Creating new plan and applying..."
            terraform apply -auto-approve
          fi

          # Capture outputs
          WEB_APP_URL=$(terraform output -raw web_app_url 2>/dev/null || echo "")
          API_GATEWAY_URL=$(terraform output -raw api_gateway_url 2>/dev/null || echo "")

          echo "web_app_url=$WEB_APP_URL" >> $GITHUB_OUTPUT
          echo "api_gateway_url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT

      - name: Generate Deployment Summary
        id: summary
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          echo "## ğŸš€ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Environment: ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“… Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test results summary
          echo "### ğŸ§ª Quality Assurance Results" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          # Validation results
          if [ "${{ needs.terraform-validate.outputs.tf_fmt_check }}" == "success" ]; then
            echo "| Terraform Format | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Terraform Format | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.terraform-validate.outputs.tf_validate_check }}" == "success" ]; then
            echo "| Terraform Validate | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Terraform Validate | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Test results
          TEST_RESULTS="${{ needs.terraform-test.outputs.test_results || 'Not available' }}"
          echo "| Infrastructure Tests | $TEST_RESULTS |" >> $GITHUB_STEP_SUMMARY

          # Security scan results
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "| Security Scan | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security Scan | âš ï¸ Issues found |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.apply.outputs.web_app_url }}" ]; then
            echo "**Application URLs:**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ Web App: ${{ steps.apply.outputs.web_app_url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ steps.apply.outputs.api_gateway_url }}" ]; then
            echo "- ğŸ”Œ API Gateway: ${{ steps.apply.outputs.api_gateway_url }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Summary:**" >> $GITHUB_STEP_SUMMARY

          # Get resource counts from state
          RESOURCE_COUNT=$(terraform state list | wc -l)
          echo "- ğŸ“¦ Total Resources: $RESOURCE_COUNT" >> $GITHUB_STEP_SUMMARY

  terraform-test:
    name: Terraform Testing
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    outputs:
      test_results: ${{ steps.test-summary.outputs.results }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Install testing tools
        run: |
          # Install terraform testing tools
          curl -L "https://github.com/terraform-linters/tflint/releases/latest/download/tflint_linux_amd64.zip" -o tflint.zip
          unzip tflint.zip
          sudo mv tflint /usr/local/bin/

          # Install checkov for additional security scanning
          pip install checkov

      - name: Run TFLint with tag validation
        id: tflint
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          echo "Running TFLint with AWS cost-allocation tag validation..."
          tflint --init --config=../../.tflint.hcl
          tflint --config=../../.tflint.hcl --format=json > tflint-results.json || echo "tflint_failed=true" >> $GITHUB_OUTPUT

          # Generate human-readable report
          tflint --config=../../.tflint.hcl --format=compact > tflint-report.txt || true

          # Count issues
          if [ -f tflint-results.json ]; then
            ISSUES=$(jq '.issues | length' tflint-results.json 2>/dev/null || echo "0")
            echo "tflint_issues=$ISSUES" >> $GITHUB_OUTPUT
          fi

      - name: Run Checkov Security Scan with tag validation
        id: checkov
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          echo "Running Checkov security scan with cost-allocation tag validation..."
          checkov -d . --config-file ../../.checkov.yaml --output json --output-file checkov-results.json \
            --soft-fail || echo "checkov_failed=true" >> $GITHUB_OUTPUT

          # Generate summary report
          checkov -d . --config-file ../../.checkov.yaml --compact --quiet > checkov-report.txt || true

          # Count failed checks
          if [ -f checkov-results.json ]; then
            FAILED_CHECKS=$(jq '.results.failed_checks | length' checkov-results.json 2>/dev/null || echo "0")
            PASSED_CHECKS=$(jq '.results.passed_checks | length' checkov-results.json 2>/dev/null || echo "0")
            echo "checkov_failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
            echo "checkov_passed_checks=$PASSED_CHECKS" >> $GITHUB_OUTPUT
          fi

      - name: Run Terraform Configuration Tests
        id: config-tests
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          echo "Running Terraform configuration tests..."

          # Test 1: Check for required providers
          echo "Checking required providers..."
          if ! grep -q "required_providers" *.tf; then
            echo "âŒ No required_providers block found"
            echo "config_tests_failed=true" >> $GITHUB_OUTPUT
          fi

          # Test 2: Check for version constraints
          echo "Checking version constraints..."
          if ! grep -q "required_version" *.tf; then
            echo "âš ï¸ No Terraform version constraint found"
          fi

          # Test 3: Check for backend configuration
          echo "Checking backend configuration..."
          if ! grep -q "backend" *.tf; then
            echo "âš ï¸ No backend configuration found"
          fi

          # Test 4: Check for resource naming conventions
          echo "Checking resource naming conventions..."
          INVALID_NAMES=$(grep -E "resource \"[^\"]*\" \"[^a-z0-9_-]*\"" *.tf | wc -l || echo "0")
          if [ "$INVALID_NAMES" -gt 0 ]; then
            echo "âš ï¸ Found $INVALID_NAMES resources with non-standard names"
          fi

          # Test 5: Check for hardcoded values
          echo "Checking for hardcoded sensitive values..."
          HARDCODED_SECRETS=$(grep -iE "(password|secret|key).*=.*\"[^$]" *.tf | grep -v "var\." | wc -l || echo "0")
          if [ "$HARDCODED_SECRETS" -gt 0 ]; then
            echo "âŒ Found $HARDCODED_SECRETS potential hardcoded secrets"
            echo "config_tests_failed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-test-results-${{ github.run_id }}
          path: |
            ${{ env.TF_WORKING_DIR }}/tflint-results.json
            ${{ env.TF_WORKING_DIR }}/tflint-report.txt
            ${{ env.TF_WORKING_DIR }}/checkov-results.json
            ${{ env.TF_WORKING_DIR }}/checkov-report.txt
          retention-days: 30

      - name: Generate test summary
        id: test-summary
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          TFLINT_STATUS="âœ… Passed"
          CHECKOV_STATUS="âœ… Passed"
          CONFIG_STATUS="âœ… Passed"

          TFLINT_ISSUES="${{ steps.tflint.outputs.tflint_issues || '0' }}"
          CHECKOV_FAILED="${{ steps.checkov.outputs.checkov_failed_checks || '0' }}"
          CHECKOV_PASSED="${{ steps.checkov.outputs.checkov_passed_checks || '0' }}"

          if [ "${{ steps.tflint.outputs.tflint_failed }}" == "true" ] || [ "$TFLINT_ISSUES" -gt 0 ]; then
            TFLINT_STATUS="âŒ Failed ($TFLINT_ISSUES issues)"
          fi

          if [ "${{ steps.checkov.outputs.checkov_failed }}" == "true" ] || [ "$CHECKOV_FAILED" -gt 0 ]; then
            CHECKOV_STATUS="âš ï¸ Issues found ($CHECKOV_FAILED failed, $CHECKOV_PASSED passed)"
          fi

          if [ "${{ steps.config-tests.outputs.config_tests_failed }}" == "true" ]; then
            CONFIG_STATUS="âŒ Failed"
          fi

          RESULTS="TFLint: $TFLINT_STATUS | Checkov: $CHECKOV_STATUS | Config: $CONFIG_STATUS"
          echo "results=$RESULTS" >> $GITHUB_OUTPUT

          echo "## ğŸ§ª Terraform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | $TFLINT_STATUS | Code quality and best practices |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | $CHECKOV_STATUS | Security and compliance |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | $CONFIG_STATUS | Terraform configuration validation |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'infra/terraform'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Run Trivy with JSON output for summary
        id: trivy-json
        run: |
          docker run --rm -v "$PWD:/workspace" aquasec/trivy config /workspace/infra/terraform \
            --format json --output /workspace/trivy-results.json \
            --severity CRITICAL,HIGH,MEDIUM || echo "trivy_failed=true" >> $GITHUB_OUTPUT

          if [ -f trivy-results.json ]; then
            # Count vulnerabilities by severity
            CRITICAL=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "MEDIUM")] | length' trivy-results.json 2>/dev/null || echo "0")

            echo "trivy_critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "trivy_high=$HIGH" >> $GITHUB_OUTPUT
            echo "trivy_medium=$MEDIUM" >> $GITHUB_OUTPUT
          fi

      - name: Run Checkov security scan
        id: checkov
        run: |
          pip install checkov

          echo "Running Checkov security scan on Terraform..."
          checkov -d infra/terraform --framework terraform \
            --output json --output-file checkov-results.json \
            --soft-fail || echo "checkov_failed=true" >> $GITHUB_OUTPUT

          if [ -f checkov-results.json ]; then
            FAILED_CHECKS=$(jq '.results.failed_checks | length' checkov-results.json 2>/dev/null || echo "0")
            PASSED_CHECKS=$(jq '.results.passed_checks | length' checkov-results.json 2>/dev/null || echo "0")

            echo "checkov_failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
            echo "checkov_passed_checks=$PASSED_CHECKS" >> $GITHUB_OUTPUT
          fi

      - name: Run TFSec security scan
        id: tfsec
        run: |
          # Install tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

          echo "Running tfsec security scan..."
          tfsec infra/terraform --format json --out tfsec-results.json \
            --soft-fail || echo "tfsec_failed=true" >> $GITHUB_OUTPUT

          if [ -f tfsec-results.json ]; then
            TFSEC_ISSUES=$(jq '.results | length' tfsec-results.json 2>/dev/null || echo "0")
            echo "tfsec_issues=$TFSEC_ISSUES" >> $GITHUB_OUTPUT
          fi

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'terraform-security'

      - name: Upload security scan artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-security-results-${{ github.run_id }}
          path: |
            trivy-results.json
            checkov-results.json
            tfsec-results.json
          retention-days: 30

      - name: Generate Security Summary
        run: |
          CRITICAL="${{ steps.trivy-json.outputs.trivy_critical || '0' }}"
          HIGH="${{ steps.trivy-json.outputs.trivy_high || '0' }}"
          MEDIUM="${{ steps.trivy-json.outputs.trivy_medium || '0' }}"
          CHECKOV_FAILED="${{ steps.checkov.outputs.checkov_failed_checks || '0' }}"
          TFSEC_ISSUES="${{ steps.tfsec.outputs.tfsec_issues || '0' }}"

          echo "## ğŸ”’ Infrastructure Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trivy Infrastructure Scan" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Additional Security Tools" >> $GITHUB_STEP_SUMMARY
          echo "- **Checkov Failed Checks:** $CHECKOV_FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **TFSec Issues:** $TFSEC_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt 0 ]; then
            echo "ğŸš¨ **Critical security issues found!** Immediate action required." >> $GITHUB_STEP_SUMMARY
          elif [ "$HIGH" -gt 0 ]; then
            echo "âš ï¸ **High severity issues found!** Review the Security tab for details." >> $GITHUB_STEP_SUMMARY
          elif [ "$MEDIUM" -gt 0 ] || [ "$CHECKOV_FAILED" -gt 0 ] || [ "$TFSEC_ISSUES" -gt 0 ]; then
            echo "âš ï¸ **Medium severity or policy issues found.** Consider reviewing the Security tab." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No critical, high, or medium severity issues found.**" >> $GITHUB_STEP_SUMMARY
          fi

  security-monitoring:
    name: Security Monitoring
    runs-on: ubuntu-latest
    needs: [terraform-apply]
    if: always() && needs.terraform-apply.result == 'success'
    env:
      HAS_WEBHOOK: ${{ secrets.DEPLOYMENT_WEBHOOK_URL != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_INFRASTRUCTURE_CI_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-InfraCI-Security-${{ github.run_id }}

      - name: Monitor security events
        if: env.HAS_WEBHOOK == 'true'
        uses: ./.github/actions/security-monitor
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          aws_region: ${{ secrets.AWS_REGION }}
          monitoring_duration: '10'
          service_name: 'infrastructure'

  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [terraform-apply, terraform-test, security-scan, security-monitoring]
    if: always() && needs.terraform-apply.result != 'skipped'
    env:
      HAS_WEBHOOK: ${{ secrets.DEPLOYMENT_WEBHOOK_URL != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify deployment start
        if: env.HAS_WEBHOOK == 'true' && github.event_name != 'pull_request'
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'start'
          service_name: 'infrastructure'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ github.sha }}
          commit_sha: ${{ github.sha }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Notify manual approval required
        if: env.HAS_WEBHOOK == 'true' && github.event_name == 'workflow_dispatch' && !inputs.dry_run
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'approval_required'
          service_name: 'infrastructure'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ github.sha }}
          commit_sha: ${{ github.sha }}
          approval_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          additional_context: |
            {
              "deployment_type": "infrastructure",
              "requires_approval": true,
              "dry_run": ${{ inputs.dry_run || false }}
            }

      - name: Notify deployment success
        if: env.HAS_WEBHOOK == 'true' && needs.terraform-apply.result == 'success'
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'success'
          service_name: 'infrastructure'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ github.sha }}
          commit_sha: ${{ github.sha }}
          deployment_url: ${{ needs.terraform-apply.outputs.web_app_url }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          additional_context: |
            {
              "deployment_type": "infrastructure",
              "test_results": "${{ needs.terraform-test.outputs.test_results }}",
              "security_scan": "${{ needs.security-scan.result }}",
              "security_monitoring": "${{ needs.security-monitoring.outputs.security_status || 'not_run' }}"
            }

      - name: Notify deployment failure
        if: env.HAS_WEBHOOK == 'true' && needs.terraform-apply.result == 'failure'
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'failure'
          service_name: 'infrastructure'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ github.sha }}
          commit_sha: ${{ github.sha }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          error_details: |
            Infrastructure deployment failed. Check the following:
            - Terraform validation: ${{ needs.terraform-validate.result }}
            - Terraform tests: ${{ needs.terraform-test.result }}
            - Security scan: ${{ needs.security-scan.result }}
            - Terraform apply: ${{ needs.terraform-apply.result }}
          additional_context: |
            {
              "deployment_type": "infrastructure",
              "failure_stage": "terraform_apply",
              "rollback_required": true
            }

      - name: Notify security alerts
        if: env.HAS_WEBHOOK == 'true' && needs.security-monitoring.outputs.security_status == 'alert'
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'security_alert'
          service_name: 'infrastructure'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ github.sha }}
          commit_sha: ${{ github.sha }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          security_event: |
            High-priority security events detected during infrastructure deployment.
            Security monitoring status: ${{ needs.security-monitoring.outputs.security_status }}
            Events detected: ${{ needs.security-monitoring.outputs.security_events_detected }}
          additional_context: |
            {
              "deployment_type": "infrastructure",
              "security_level": "high",
              "immediate_action_required": true
            }

      - name: Log notification summary
        run: |
          echo "## ğŸ“¢ Notification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Status:** ${{ needs.terraform-apply.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Security Status:** ${{ needs.security-monitoring.outputs.security_status || 'not_monitored' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Notifications Sent:** ${{ env.HAS_WEBHOOK == 'true' && 'Yes' || 'No (webhook not configured)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.terraform-apply.result }}" = "success" ]; then
            echo "âœ… **Infrastructure deployment completed successfully**" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ needs.terraform-apply.outputs.web_app_url }}" ]; then
              echo "ğŸŒ **Application URL:** ${{ needs.terraform-apply.outputs.web_app_url }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Infrastructure deployment failed**" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“‹ **Action Required:** Review workflow logs and address issues" >> $GITHUB_STEP_SUMMARY
          fi
