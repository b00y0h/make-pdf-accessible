name: Web Application CI

on:
  push:
    branches: [main]
    paths:
      - 'web/**'
      - '.github/workflows/web-ci.yml'
  pull_request:
    paths:
      - 'web/**'
      - '.github/workflows/web-ci.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean
      emergency_deployment:
        description: 'Emergency deployment (bypasses some checks for non-prod)'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'
  WEB_WORKING_DIR: 'web'

jobs:
  setup-environment:
    name: Setup Environment Configuration
    runs-on: ubuntu-latest
    outputs:
      require_approval: ${{ steps.env-config.outputs.require_approval }}
      security_threshold: ${{ steps.env-config.outputs.security_threshold }}
      deployment_strategy: ${{ steps.env-config.outputs.deployment_strategy }}
      resource_prefix: ${{ steps.env-config.outputs.resource_prefix }}
      testing_config: ${{ steps.env-config.outputs.testing_config }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment configuration
        id: env-config
        uses: ./.github/actions/setup-environment
        with:
          environment: ${{ inputs.environment || 'dev' }}

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web_changed: ${{ steps.changes.outputs.web_changed }}
      should_deploy: ${{ steps.deploy-decision.outputs.should_deploy }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect web application changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.force_deploy }}" == "true" ]; then
              echo "web_changed=true" >> $GITHUB_OUTPUT
              echo "Force deployment requested"
            else
              echo "web_changed=true" >> $GITHUB_OUTPUT
              echo "Manual dispatch - assuming changes"
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "web_changed=true" >> $GITHUB_OUTPUT
            echo "Pull request - running tests and build validation"
          else
            # Check for changes in web directory or workflow
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || echo "")

            if [ -z "$CHANGED_FILES" ]; then
              # If we can't detect changes (e.g., first push), assume changes
              echo "web_changed=true" >> $GITHUB_OUTPUT
              echo "Cannot detect changes - assuming web changes"
            elif echo "$CHANGED_FILES" | grep -q "^web/\|^\.github/workflows/web-ci\.yml"; then
              echo "web_changed=true" >> $GITHUB_OUTPUT
              echo "Web application changes detected"
            else
              echo "web_changed=false" >> $GITHUB_OUTPUT
              echo "No web application changes detected"
            fi
          fi

      - name: Determine deployment decision
        id: deploy-decision
        run: |
          if [ "${{ steps.changes.outputs.web_changed }}" == "true" ] && [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Will deploy to production"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ steps.changes.outputs.web_changed }}" == "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Will deploy via manual dispatch"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "Will not deploy"
          fi

  dependency-security-scan:
    name: Web Dependency Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web_changed == 'true'
    outputs:
      security_passed: ${{ steps.security-check.outputs.security_passed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd ${{ env.WEB_WORKING_DIR }}
          pnpm install --frozen-lockfile

      - name: Run npm audit
        id: npm-audit
        run: |
          cd ${{ env.WEB_WORKING_DIR }}

          echo "Running npm audit security scan..."
          pnpm audit --json > ../npm-audit-results.json || echo "npm_audit_failed=true" >> $GITHUB_OUTPUT

          cd ..

          if [ -f npm-audit-results.json ]; then
            # Parse npm audit results
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json 2>/dev/null || echo "0")
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit-results.json 2>/dev/null || echo "0")
            LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit-results.json 2>/dev/null || echo "0")

            echo "npm_critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "npm_high=$HIGH" >> $GITHUB_OUTPUT
            echo "npm_moderate=$MODERATE" >> $GITHUB_OUTPUT
            echo "npm_low=$LOW" >> $GITHUB_OUTPUT

            echo "npm audit results:"
            echo "- Critical: $CRITICAL"
            echo "- High: $HIGH"
            echo "- Moderate: $MODERATE"
            echo "- Low: $LOW"
          fi

      - name: Run ESLint security rules
        id: eslint-security
        run: |
          cd ${{ env.WEB_WORKING_DIR }}

          echo "Installing ESLint security plugins..."
          pnpm add --save-dev eslint-plugin-security

          echo "Running ESLint with security rules..."

          # Create security-focused ESLint config
          cat > .eslintrc.security.js << 'EOF'
          module.exports = {
            extends: [
              './.eslintrc.js'
            ],
            plugins: ['security'],
            rules: {
              'security/detect-object-injection': 'error',
              'security/detect-non-literal-regexp': 'error',
              'security/detect-unsafe-regex': 'error',
              'security/detect-buffer-noassert': 'error',
              'security/detect-child-process': 'error',
              'security/detect-disable-mustache-escape': 'error',
              'security/detect-eval-with-expression': 'error',
              'security/detect-no-csrf-before-method-override': 'error',
              'security/detect-non-literal-fs-filename': 'error',
              'security/detect-non-literal-require': 'error',
              'security/detect-possible-timing-attacks': 'error',
              'security/detect-pseudoRandomBytes': 'error'
            }
          };
          EOF

          npx eslint . --config .eslintrc.security.js --format json --output-file ../eslint-security-results.json || echo "eslint_security_failed=true" >> $GITHUB_OUTPUT

          cd ..

          if [ -f eslint-security-results.json ]; then
            ESLINT_ISSUES=$(jq '. | length' eslint-security-results.json 2>/dev/null || echo "0")
            echo "eslint_security_issues=$ESLINT_ISSUES" >> $GITHUB_OUTPUT
            echo "ESLint security issues found: $ESLINT_ISSUES"
          fi

      - name: Check security status
        id: security-check
        run: |
          CRITICAL="${{ steps.npm-audit.outputs.npm_critical || '0' }}"
          HIGH="${{ steps.npm-audit.outputs.npm_high || '0' }}"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "security_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Critical vulnerabilities found - blocking build"
          elif [ "$HIGH" -gt 5 ]; then
            echo "security_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Too many high severity vulnerabilities found - blocking build"
          else
            echo "security_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Security scan passed"
          fi

      - name: Upload dependency security results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-dependency-security-${{ github.run_id }}
          path: |
            npm-audit-results.json
            eslint-security-results.json
          retention-days: 30

      - name: Generate dependency security summary
        run: |
          CRITICAL="${{ steps.npm-audit.outputs.npm_critical || '0' }}"
          HIGH="${{ steps.npm-audit.outputs.npm_high || '0' }}"
          MODERATE="${{ steps.npm-audit.outputs.npm_moderate || '0' }}"
          LOW="${{ steps.npm-audit.outputs.npm_low || '0' }}"
          ESLINT_ISSUES="${{ steps.eslint-security.outputs.eslint_security_issues || '0' }}"

          echo "## ðŸ”’ Web Dependency Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### npm audit Results" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ESLint Security Issues" >> $GITHUB_STEP_SUMMARY
          echo "- **Issues Found:** $ESLINT_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt 0 ]; then
            echo "ðŸš¨ **Critical vulnerabilities found!** Build will be blocked." >> $GITHUB_STEP_SUMMARY
          elif [ "$HIGH" -gt 5 ]; then
            echo "âš ï¸ **Too many high severity vulnerabilities!** Build will be blocked." >> $GITHUB_STEP_SUMMARY
          elif [ "$HIGH" -gt 0 ]; then
            echo "âš ï¸ **High severity vulnerabilities found!** Review recommended." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No critical or high severity vulnerabilities found.**" >> $GITHUB_STEP_SUMMARY
          fi

  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    needs: [detect-changes, dependency-security-scan]
    if: needs.detect-changes.outputs.web_changed == 'true' && needs.dependency-security-scan.outputs.security_passed == 'true'
    outputs:
      build_artifact: ${{ steps.upload-artifact.outputs.artifact-id }}
      build_version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          cd ${{ env.WEB_WORKING_DIR }}
          pnpm install --frozen-lockfile

      - name: Run linting
        run: |
          cd ${{ env.WEB_WORKING_DIR }}
          pnpm lint

      - name: Run type checking
        run: |
          cd ${{ env.WEB_WORKING_DIR }}
          pnpm run type-check || npx tsc --noEmit

      - name: Run unit tests
        if: inputs.skip_tests != true
        id: unit-tests
        run: |
          cd ${{ env.WEB_WORKING_DIR }}

          echo "Running Jest unit tests..."
          pnpm test --run --coverage --coverageReporters=text --coverageReporters=lcov \
            --coverageReporters=json --coverageThreshold='{"global":{"branches":70,"functions":70,"lines":70,"statements":70}}' \
            --maxWorkers=2 --passWithNoTests || echo "unit_tests_failed=true" >> $GITHUB_OUTPUT

          # Extract coverage percentage
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -e "
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const lines = coverage.total.lines.pct;
              console.log(lines);
            } catch (e) {
              console.log('0');
            }
            ")
            echo "unit_coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "unit_coverage=0" >> $GITHUB_OUTPUT
          fi

      - name: Run component tests
        if: inputs.skip_tests != true
        id: component-tests
        run: |
          cd ${{ env.WEB_WORKING_DIR }}

          echo "Running component tests..."
          # Run tests specifically for components
          pnpm test --run --testPathPattern="components|__tests__" --passWithNoTests \
            --verbose || echo "component_tests_failed=true" >> $GITHUB_OUTPUT

      - name: Run integration tests
        if: inputs.skip_tests != true
        id: integration-tests
        run: |
          cd ${{ env.WEB_WORKING_DIR }}

          echo "Running integration tests..."
          # Run tests for pages and API routes
          pnpm test --run --testPathPattern="pages|api|integration" --passWithNoTests \
            --verbose || echo "integration_tests_failed=true" >> $GITHUB_OUTPUT

      - name: Run accessibility tests
        if: inputs.skip_tests != true
        id: a11y-tests
        run: |
          cd ${{ env.WEB_WORKING_DIR }}

          echo "Running accessibility tests..."
          # Install axe-core for accessibility testing if not present
          if ! pnpm list @axe-core/react >/dev/null 2>&1; then
            echo "Installing accessibility testing dependencies..."
            pnpm add -D @axe-core/react jest-axe
          fi

          # Run accessibility-specific tests
          pnpm test --run --testPathPattern="a11y|accessibility" --passWithNoTests \
            --verbose || echo "a11y_tests_failed=true" >> $GITHUB_OUTPUT

      - name: Generate build version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="main-$(git rev-parse --short ${{ github.sha }})-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Build application
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
        run: |
          cd ${{ env.WEB_WORKING_DIR }}

          # Set build-time environment variables
          echo "NEXT_PUBLIC_BUILD_VERSION=${{ steps.version.outputs.version }}" >> .env.production
          echo "NEXT_PUBLIC_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .env.production
          echo "NEXT_PUBLIC_COMMIT_SHA=${{ github.sha }}" >> .env.production

          # Build the application
          pnpm build

          # Verify build output
          if [ ! -d ".next" ]; then
            echo "Error: Build output directory not found"
            exit 1
          fi

          # Create deployment package
          mkdir -p ../build-output
          cp -r .next/static ../build-output/
          cp -r .next/standalone ../build-output/ 2>/dev/null || echo "No standalone output"
          cp -r public ../build-output/ 2>/dev/null || echo "No public directory"

          # Copy build manifest and other metadata
          cp .next/build-manifest.json ../build-output/ 2>/dev/null || echo "No build manifest"

          # Create deployment metadata
          cat > ../build-output/deployment-info.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commitSha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "environment": "${{ inputs.environment || 'prod' }}",
            "buildId": "${{ github.run_id }}"
          }
          EOF

      - name: Upload test results and coverage
        if: always() && inputs.skip_tests != true
        uses: actions/upload-artifact@v4
        with:
          name: web-test-results-${{ steps.version.outputs.version }}
          path: |
            ${{ env.WEB_WORKING_DIR }}/coverage/
            ${{ env.WEB_WORKING_DIR }}/test-results.xml
          retention-days: 30

      - name: Upload build artifacts
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ steps.version.outputs.version }}
          path: |
            ${{ env.WEB_WORKING_DIR }}/.next/
            build-output/
          retention-days: 30
          compression-level: 6

      - name: Generate test and build summary
        run: |
          cd ${{ env.WEB_WORKING_DIR }}

          echo "## ðŸ—ï¸ Web Application Test & Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Node.js:** ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test results summary
          if [ "${{ inputs.skip_tests }}" != "true" ]; then
            echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
            echo "| Test Suite | Status | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|--------|----------|" >> $GITHUB_STEP_SUMMARY

            UNIT_STATUS="âœ… Passed"
            COMPONENT_STATUS="âœ… Passed"
            INTEGRATION_STATUS="âœ… Passed"
            A11Y_STATUS="âœ… Passed"

            if [ "${{ steps.unit-tests.outputs.unit_tests_failed }}" == "true" ]; then
              UNIT_STATUS="âŒ Failed"
            fi
            if [ "${{ steps.component-tests.outputs.component_tests_failed }}" == "true" ]; then
              COMPONENT_STATUS="âŒ Failed"
            fi
            if [ "${{ steps.integration-tests.outputs.integration_tests_failed }}" == "true" ]; then
              INTEGRATION_STATUS="âŒ Failed"
            fi
            if [ "${{ steps.a11y-tests.outputs.a11y_tests_failed }}" == "true" ]; then
              A11Y_STATUS="âŒ Failed"
            fi

            UNIT_COVERAGE="${{ steps.unit-tests.outputs.unit_coverage || '0' }}"

            echo "| Unit Tests | $UNIT_STATUS | ${UNIT_COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Component Tests | $COMPONENT_STATUS | - |" >> $GITHUB_STEP_SUMMARY
            echo "| Integration Tests | $INTEGRATION_STATUS | - |" >> $GITHUB_STEP_SUMMARY
            echo "| Accessibility Tests | $A11Y_STATUS | - |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Overall test status
            if [ "${{ steps.unit-tests.outputs.unit_tests_failed }}" == "true" ] || \
               [ "${{ steps.component-tests.outputs.component_tests_failed }}" == "true" ] || \
               [ "${{ steps.integration-tests.outputs.integration_tests_failed }}" == "true" ] || \
               [ "${{ steps.a11y-tests.outputs.a11y_tests_failed }}" == "true" ]; then
              echo "**Test Status:** âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Test Status:** âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Build size analysis
          echo "### ðŸ“¦ Build Analysis" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next" ]; then
            BUILD_SIZE=$(du -sh .next | cut -f1)
            echo "**Build Size:** $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY

            # Count files
            STATIC_FILES=$(find .next/static -type f | wc -l 2>/dev/null || echo "0")
            echo "**Static Files:** $STATIC_FILES" >> $GITHUB_STEP_SUMMARY

            # Check for build warnings
            if [ -f ".next/build-manifest.json" ]; then
              echo "**Build Status:** âœ… Successful" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Fail if tests failed
          if [ "${{ inputs.skip_tests }}" != "true" ]; then
            if [ "${{ steps.unit-tests.outputs.unit_tests_failed }}" == "true" ] || \
               [ "${{ steps.component-tests.outputs.component_tests_failed }}" == "true" ] || \
               [ "${{ steps.integration-tests.outputs.integration_tests_failed }}" == "true" ] || \
               [ "${{ steps.a11y-tests.outputs.a11y_tests_failed }}" == "true" ]; then
              echo "âŒ **Deployment blocked due to test failures**" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

          echo "âœ… **Ready for deployment**" >> $GITHUB_STEP_SUMMARY

  environment-gate:
    name: Environment Deployment Gate
    runs-on: ubuntu-latest
    needs:
      [
        setup-environment,
        detect-changes,
        test-and-build,
        dependency-security-scan,
      ]
    if: needs.detect-changes.outputs.should_deploy == 'true'
    outputs:
      gate_passed: ${{ steps.gate.outputs.gate_passed }}
      approval_required: ${{ steps.gate.outputs.approval_required }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare security results
        id: security-results
        run: |
          # Combine security scan results
          SECURITY_RESULTS='{
            "critical": ${{ needs.dependency-security-scan.outputs.npm_critical || 0 }},
            "high": ${{ needs.dependency-security-scan.outputs.npm_high || 0 }},
            "medium": ${{ needs.dependency-security-scan.outputs.npm_moderate || 0 }}
          }'
          echo "results=$SECURITY_RESULTS" >> $GITHUB_OUTPUT

      - name: Run environment gate
        id: gate
        uses: ./.github/actions/environment-gate
        with:
          environment: ${{ inputs.environment || 'dev' }}
          require_approval: ${{ needs.setup-environment.outputs.require_approval }}
          security_threshold: ${{ needs.setup-environment.outputs.security_threshold }}
          deployment_type: 'web'
          security_results: ${{ steps.security-results.outputs.results }}

  deploy:
    name: Deploy to S3 and CloudFront
    runs-on: ubuntu-latest
    needs: [setup-environment, detect-changes, test-and-build, environment-gate]
    if: |
      needs.environment-gate.outputs.gate_passed == 'true' &&
      needs.detect-changes.outputs.should_deploy == 'true'
    environment:
      name: ${{ inputs.environment || 'dev' }}-web
      url: ${{ steps.deploy.outputs.web_app_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_WEB_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-WebDeploy-${{ github.run_id }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build-${{ needs.test-and-build.outputs.build_version }}
          path: ./artifacts

      - name: Get deployment configuration
        id: config
        run: |
          # Get S3 bucket and CloudFront distribution from Terraform outputs
          S3_BUCKET=$(aws s3api list-buckets --query "Buckets[?contains(Name, 'web-assets')].Name" --output text | head -1)

          if [ -z "$S3_BUCKET" ]; then
            echo "Error: Could not find web assets S3 bucket"
            exit 1
          fi

          # Get CloudFront distribution ID
          DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Comment, 'PDF Accessibility Platform')].Id" --output text | head -1)

          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "Error: Could not find CloudFront distribution"
            exit 1
          fi

          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
          echo "Using S3 bucket: $S3_BUCKET"
          echo "Using CloudFront distribution: $DISTRIBUTION_ID"

      - name: Backup current deployment
        id: backup
        run: |
          BACKUP_PREFIX="backups/$(date +%Y%m%d-%H%M%S)-${{ github.sha }}"

          # Check if there are existing files to backup
          if aws s3 ls s3://${{ steps.config.outputs.s3_bucket }}/ --recursive | grep -q .; then
            echo "Creating backup of current deployment..."
            aws s3 sync s3://${{ steps.config.outputs.s3_bucket }}/ s3://${{ steps.config.outputs.s3_bucket }}/$BACKUP_PREFIX/ \
              --exclude "backups/*" \
              --quiet
            echo "backup_path=$BACKUP_PREFIX" >> $GITHUB_OUTPUT
            echo "Backup created at: $BACKUP_PREFIX"
          else
            echo "No existing deployment to backup"
            echo "backup_path=" >> $GITHUB_OUTPUT
          fi

      - name: Prepare deployment files
        run: |
          # Prepare the deployment directory
          mkdir -p deployment

          # Copy Next.js static files
          if [ -d "artifacts/.next/static" ]; then
            cp -r artifacts/.next/static deployment/_next/
          fi

          # Copy public files
          if [ -d "artifacts/build-output/public" ]; then
            cp -r artifacts/build-output/public/* deployment/
          fi

          # Copy standalone build if available
          if [ -d "artifacts/build-output/standalone" ]; then
            cp -r artifacts/build-output/standalone/* deployment/
          fi

          # Ensure we have an index.html
          if [ ! -f "deployment/index.html" ]; then
            # Create a basic index.html if none exists
            cat > deployment/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>PDF Accessibility Platform</title>
            <meta name="viewport" content="width=device-width, initial-scale=1">
          </head>
          <body>
            <div id="__next"></div>
            <script src="/_next/static/chunks/main.js"></script>
          </body>
          </html>
          EOF
          fi

          # Copy deployment metadata
          if [ -f "artifacts/build-output/deployment-info.json" ]; then
            cp artifacts/build-output/deployment-info.json deployment/
          fi

      - name: Deploy to S3
        id: s3-deploy
        run: |
          echo "Deploying to S3 bucket: ${{ steps.config.outputs.s3_bucket }}"

          # Sync files with appropriate cache headers
          aws s3 sync deployment/ s3://${{ steps.config.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "deployment-info.json"

          # Upload HTML files with shorter cache
          aws s3 sync deployment/ s3://${{ steps.config.outputs.s3_bucket }}/ \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html" \
            --include "deployment-info.json"

          # Set specific metadata for key files
          aws s3 cp deployment/index.html s3://${{ steps.config.outputs.s3_bucket }}/index.html \
            --cache-control "public, max-age=0, must-revalidate" \
            --content-type "text/html; charset=utf-8" \
            --metadata "version=${{ needs.test-and-build.outputs.build_version }},build-id=${{ github.run_id }}"

          echo "S3 deployment completed"

      - name: Invalidate CloudFront cache
        id: cloudfront-invalidate
        run: |
          echo "Creating CloudFront invalidation..."

          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.config.outputs.distribution_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "invalidation_id=$INVALIDATION_ID" >> $GITHUB_OUTPUT
          echo "CloudFront invalidation created: $INVALIDATION_ID"

          # Wait for invalidation to complete (with timeout)
          echo "Waiting for invalidation to complete..."
          timeout 300 aws cloudfront wait invalidation-completed \
            --distribution-id ${{ steps.config.outputs.distribution_id }} \
            --id $INVALIDATION_ID || echo "Invalidation timeout - continuing"

      - name: Get deployment URLs
        id: deploy
        run: |
          # Get CloudFront domain
          CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution \
            --id ${{ steps.config.outputs.distribution_id }} \
            --query 'Distribution.DomainName' \
            --output text)

          # Check if custom domain is configured
          CUSTOM_DOMAIN=$(aws cloudfront get-distribution \
            --id ${{ steps.config.outputs.distribution_id }} \
            --query 'Distribution.DistributionConfig.Aliases.Items[0]' \
            --output text 2>/dev/null || echo "None")

          if [ "$CUSTOM_DOMAIN" != "None" ] && [ "$CUSTOM_DOMAIN" != "null" ]; then
            WEB_APP_URL="https://$CUSTOM_DOMAIN"
          else
            WEB_APP_URL="https://$CLOUDFRONT_DOMAIN"
          fi

          echo "web_app_url=$WEB_APP_URL" >> $GITHUB_OUTPUT
          echo "cloudfront_domain=$CLOUDFRONT_DOMAIN" >> $GITHUB_OUTPUT
          echo "Web application URL: $WEB_APP_URL"

      - name: Verify deployment
        id: verify
        run: |
          echo "Verifying deployment..."

          # Wait a moment for CloudFront to propagate
          sleep 30

          # Test the main page
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.web_app_url }}" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Deployment verification successful (HTTP $HTTP_STATUS)"
            echo "verification_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Deployment verification failed (HTTP $HTTP_STATUS)"
            echo "verification_status=failed" >> $GITHUB_OUTPUT

            # Try to get more details
            echo "Attempting to get response details..."
            curl -v "${{ steps.deploy.outputs.web_app_url }}" || true
          fi

          # Test a static asset
          STATIC_URL="${{ steps.deploy.outputs.web_app_url }}/_next/static"
          STATIC_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$STATIC_URL" || echo "000")
          echo "Static assets status: $STATIC_STATUS"

      - name: Generate deployment summary
        run: |
          echo "## ðŸš€ Web Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.test-and-build.outputs.build_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Web App: ${{ steps.deploy.outputs.web_app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- â˜ï¸ CloudFront: https://${{ steps.deploy.outputs.cloudfront_domain }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ S3 Bucket: ${{ steps.config.outputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ CloudFront Distribution: ${{ steps.config.outputs.distribution_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Invalidation: ${{ steps.cloudfront-invalidate.outputs.invalidation_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outputs.verification_status }}" = "success" ]; then
            echo "**Status:** âœ… Deployment successful and verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âš ï¸ Deployment completed but verification failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Track deployment state
        if: always()
        uses: ./.github/actions/deployment-state
        with:
          action: track
          service: web
          environment: ${{ inputs.environment || 'prod' }}
          version: ${{ needs.test-and-build.outputs.build_version }}
          status: ${{ steps.verify.outputs.verification_status == 'success' && 'success' || 'failed' }}
          health_status: ${{ steps.verify.outputs.verification_status || 'unknown' }}

      - name: Trigger automatic rollback on failure
        if: failure() || (steps.verify.outputs.verification_status == 'failed')
        uses: ./.github/actions/auto-rollback
        with:
          service: web
          environment: ${{ inputs.environment || 'prod' }}
          health_check_failed: ${{ steps.verify.outputs.verification_status == 'failed' || 'true' }}
          rollback_threshold: 2
          github_token: ${{ secrets.GITHUB_TOKEN }}

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [detect-changes, test-and-build, deploy]
    if: failure() && needs.deploy.result == 'failure'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_WEB_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-WebRollback-${{ github.run_id }}

      - name: Perform rollback
        run: |
          echo "âš ï¸ Deployment failed - attempting rollback"

          # This is a placeholder for rollback logic
          # In a real scenario, you would restore from the backup created in the deploy job
          echo "Rollback functionality would be implemented here"
          echo "This could involve restoring from the backup or deploying a known good version"

  security-monitoring:
    name: Security Monitoring
    runs-on: ubuntu-latest
    needs: [detect-changes, test-and-build, deploy]
    if: always() && needs.deploy.result == 'success'
    env:
      HAS_WEBHOOK: ${{ secrets.DEPLOYMENT_WEBHOOK_URL != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_WEB_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-WebSecurity-${{ github.run_id }}

      - name: Monitor web security events
        if: env.HAS_WEBHOOK == 'true'
        uses: ./.github/actions/security-monitor
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          aws_region: ${{ secrets.AWS_REGION }}
          monitoring_duration: '5'
          service_name: 'web-application'

  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs:
      [detect-changes, test-and-build, deploy, rollback, security-monitoring]
    if: always() && needs.detect-changes.outputs.should_deploy == 'true'
    env:
      HAS_WEBHOOK: ${{ secrets.DEPLOYMENT_WEBHOOK_URL != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify deployment start
        if: env.HAS_WEBHOOK == 'true' && github.event_name != 'pull_request'
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'start'
          service_name: 'web-application'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ needs.test-and-build.outputs.build_version }}
          commit_sha: ${{ github.sha }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          additional_context: |
            {
              "deployment_type": "web",
              "build_version": "${{ needs.test-and-build.outputs.build_version }}",
              "trigger": "${{ github.event_name }}"
            }

      - name: Notify deployment success
        if: env.HAS_WEBHOOK == 'true' && needs.deploy.result == 'success'
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'success'
          service_name: 'web-application'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ needs.test-and-build.outputs.build_version }}
          commit_sha: ${{ github.sha }}
          deployment_url: ${{ needs.deploy.outputs.web_app_url }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          additional_context: |
            {
              "deployment_type": "web",
              "cloudfront_domain": "${{ needs.deploy.outputs.cloudfront_domain }}",
              "verification_status": "${{ needs.deploy.outputs.verification_status }}",
              "security_status": "${{ needs.security-monitoring.outputs.security_status || 'not_monitored' }}"
            }

      - name: Notify deployment failure
        if: env.HAS_WEBHOOK == 'true' && needs.deploy.result == 'failure'
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'failure'
          service_name: 'web-application'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ needs.test-and-build.outputs.build_version }}
          commit_sha: ${{ github.sha }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          error_details: |
            Web application deployment failed during the following stages:
            - Build and Test: ${{ needs.test-and-build.result }}
            - S3 Deployment: ${{ needs.deploy.result }}

            Common issues to check:
            - Build compilation errors
            - S3 bucket permissions
            - CloudFront distribution configuration
            - DNS/SSL certificate issues

            Rollback status: ${{ needs.rollback.result || 'not_attempted' }}
          additional_context: |
            {
              "deployment_type": "web",
              "build_version": "${{ needs.test-and-build.outputs.build_version }}",
              "rollback_attempted": "${{ needs.rollback.result != '' }}",
              "manual_intervention_required": true
            }

      - name: Notify rollback initiated
        if: env.HAS_WEBHOOK == 'true' && needs.rollback.result != 'skipped' && needs.rollback.result != ''
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'rollback'
          service_name: 'web-application'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ needs.test-and-build.outputs.build_version }}
          commit_sha: ${{ github.sha }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          error_details: |
            Automatic rollback initiated due to deployment failure.

            Rollback status: ${{ needs.rollback.result }}
            Original deployment version: ${{ needs.test-and-build.outputs.build_version }}

            The previous stable version has been restored.
            Manual verification of the application is recommended.
          additional_context: |
            {
              "deployment_type": "web",
              "rollback_reason": "deployment_failure",
              "rollback_status": "${{ needs.rollback.result }}",
              "verification_required": true
            }

      - name: Notify security alerts
        if: env.HAS_WEBHOOK == 'true' && needs.security-monitoring.outputs.security_status == 'alert'
        uses: ./.github/actions/notify-deployment
        with:
          webhook_url: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}
          notification_type: 'security_alert'
          service_name: 'web-application'
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ needs.test-and-build.outputs.build_version }}
          commit_sha: ${{ github.sha }}
          deployment_url: ${{ needs.deploy.outputs.web_app_url }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          security_event: |
            Security events detected during web application deployment:
            - Application URL: ${{ needs.deploy.outputs.web_app_url }}
            - Security status: ${{ needs.security-monitoring.outputs.security_status }}
            - Events detected: ${{ needs.security-monitoring.outputs.security_events_detected }}

            Immediate security review recommended for the deployed web application.
          additional_context: |
            {
              "deployment_type": "web",
              "security_level": "high",
              "application_url": "${{ needs.deploy.outputs.web_app_url }}",
              "immediate_action_required": true
            }

      - name: Log notification summary
        run: |
          echo "## ðŸ“¢ Web Deployment Notifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.test-and-build.outputs.build_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Status:** ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Security Status:** ${{ needs.security-monitoring.outputs.security_status || 'not_monitored' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Notifications Sent:** ${{ env.HAS_WEBHOOK == 'true' && 'Yes' || 'No (webhook not configured)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… **Web application deployed successfully**" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ needs.deploy.outputs.web_app_url }}" ]; then
              echo "ðŸŒ **Application URL:** ${{ needs.deploy.outputs.web_app_url }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Web application deployment failed**" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.rollback.result }}" != "skipped" ] && [ -n "${{ needs.rollback.result }}" ]; then
              echo "ðŸ”„ **Rollback Status:** ${{ needs.rollback.result }}" >> $GITHUB_STEP_SUMMARY
            fi
            echo "ðŸ“‹ **Action Required:** Review deployment logs and address issues" >> $GITHUB_STEP_SUMMARY
          fi
